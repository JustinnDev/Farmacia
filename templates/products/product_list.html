{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if category %}Productos - {{ category.name }}{% elif search_query %}Resultados de búsqueda{% else %}Productos{% endif %} - FarmaYa
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/geolocation.js' %}"></script>
<script>
let debounceTimer;
const searchInput = document.getElementById('searchInput');
const autocompleteResults = document.getElementById('autocompleteResults');

// Función debounce para limitar las peticiones
function debounce(func, wait) {
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(debounceTimer);
            func(...args);
        };
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(later, wait);
    };
}

// Función para buscar sugerencias
async function searchProducts(query) {
    if (query.length < 2) {
        // Agregar animación de contracción
        autocompleteResults.classList.remove('show');
        autocompleteResults.classList.add('hide');
        setTimeout(() => {
            autocompleteResults.style.display = '';
        }, 200);
        return;
    }

    try {
        const response = await fetch(`/products/autocomplete/?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.results && data.results.length > 0) {
            displayResults(data.results);
        } else {
            // Agregar animación de contracción
            autocompleteResults.classList.remove('show');
            autocompleteResults.classList.add('hide');
            setTimeout(() => {
                autocompleteResults.style.display = '';
            }, 200);
        }
    } catch (error) {
        console.error('Error fetching autocomplete results:', error);
        // Agregar animación de contracción
        autocompleteResults.classList.remove('show');
        autocompleteResults.classList.add('hide');
        setTimeout(() => {
            autocompleteResults.style.display = '';
        }, 200);
    }
}

// Función para mostrar resultados
function displayResults(results) {
    autocompleteResults.innerHTML = '';

    results.forEach(product => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item p-2 border-bottom cursor-pointer';
        item.onclick = () => {
            // Completar el campo de búsqueda con el nombre del producto
            searchInput.value = product.name;
            // Ocultar las sugerencias
            autocompleteResults.classList.remove('show');
            autocompleteResults.classList.add('hide');
            setTimeout(() => {
                autocompleteResults.style.display = '';
            }, 200);
            // Ejecutar automáticamente la búsqueda
            searchInput.form.submit();
        };

        item.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0 me-2">
                    <i class="fas fa-search text-muted"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold">${product.name}</div>
                </div>
            </div>
        `;

        autocompleteResults.appendChild(item);
    });

    // Agregar animación de expansión
    autocompleteResults.classList.remove('hide');
    autocompleteResults.classList.add('show');
    autocompleteResults.style.display = 'block';
}

// Event listener con debounce
searchInput.addEventListener('input', debounce(function(e) {
    const query = e.target.value.trim();
    searchProducts(query);
}, 300));

// Ocultar resultados al hacer click fuera
document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !autocompleteResults.contains(e.target)) {
        // Agregar animación de contracción
        autocompleteResults.classList.remove('show');
        autocompleteResults.classList.add('hide');
        setTimeout(() => {
            autocompleteResults.style.display = '';
        }, 200);
    }
});

// Ocultar resultados al presionar Escape
searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Agregar animación de contracción
        autocompleteResults.classList.remove('show');
        autocompleteResults.classList.add('hide');
        setTimeout(() => {
            autocompleteResults.style.display = '';
        }, 200);
    }
});

// Location-based filtering
let userLocation = null;
const locationButton = document.getElementById('locationButton');
const locationStatus = document.getElementById('locationStatus');
const distanceSlider = document.getElementById('distanceSlider');
const distanceValue = document.getElementById('distanceValue');

// Function to apply sorting with location filter
function applySorting(sortValue) {
    const url = new URL(window.location);
    url.searchParams.set('sort', sortValue);

    // If location is active, preserve it
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('lat') && urlParams.has('lng')) {
        url.searchParams.set('lat', urlParams.get('lat'));
        url.searchParams.set('lng', urlParams.get('lng'));
        url.searchParams.set('distance', urlParams.get('distance') || '10');
    }

    window.location.href = url.toString();
}

async function getUserLocation() {
    try {
        locationButton.disabled = true;
        locationButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo ubicación...';

        userLocation = await geolocationManager.getCurrentPosition();

        locationStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> Ubicación obtenida';
        locationButton.innerHTML = '<i class="fas fa-map-marker-alt"></i> Cambiar ubicación';
        locationButton.disabled = false;

        // Apply location filter
        applyLocationFilter();

    } catch (error) {
        console.error('Error getting location:', error);
        locationStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> ' + GeolocationManager.getErrorMessage(error);
        locationButton.innerHTML = '<i class="fas fa-map-marker-alt"></i> Obtener ubicación';
        locationButton.disabled = false;
    }
}

function applyLocationFilter() {
    if (!userLocation) return;

    const url = new URL(window.location);
    url.searchParams.set('lat', userLocation.latitude);
    url.searchParams.set('lng', userLocation.longitude);
    url.searchParams.set('distance', distanceSlider.value);

    // Preserve current sort parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('sort')) {
        url.searchParams.set('sort', urlParams.get('sort'));
    }

    window.location.href = url.toString();
}

function clearLocationFilter() {
    const url = new URL(window.location);
    url.searchParams.delete('lat');
    url.searchParams.delete('lng');
    url.searchParams.delete('distance');

    // Preserve current sort parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('sort')) {
        url.searchParams.set('sort', urlParams.get('sort'));
    }

    window.location.href = url.toString();
}

// Initialize location status and slider
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('lat') && urlParams.has('lng')) {
        userLocation = {
            latitude: parseFloat(urlParams.get('lat')),
            longitude: parseFloat(urlParams.get('lng'))
        };
        locationStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i> Filtro de ubicación activo';
        locationButton.innerHTML = '<i class="fas fa-map-marker-alt"></i> Cambiar ubicación';
    }

    // Set slider value from URL parameter or session
    if (urlParams.has('distance')) {
        distanceSlider.value = urlParams.get('distance');
        distanceValue.textContent = urlParams.get('distance');
    }

    // Update distance value display when slider changes
    distanceSlider.addEventListener('input', function() {
        distanceValue.textContent = this.value;
    });
});
</script>
{% endblock %}

{% block content %}
<!-- Barra de búsqueda global arriba -->
<div class="container-fluid mb-4" style="position: relative;">
    <!-- Contenedor de sugerencias FUERA del row para evitar cortes -->
    <div id="autocompleteResults" class="autocomplete-results position-absolute w-100 bg-white border rounded shadow-lg"
         style="top: 100%; left: 50%; transform: translateX(-50%); z-index: 1070; display: none; margin-top: 2px; max-width: 800px; max-height: none; overflow: visible;">
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card shadow-sm" style="overflow: visible;">
                <div class="card-body py-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <form method="get" action="{% url 'products:product_search' %}">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg border-0 shadow-none"
                                                id="searchInput" name="q"
                                                placeholder="Buscar productos por nombre, marca o descripción..."
                                                value="{{ search_query }}" autocomplete="off"
                                                style="font-size: 1.1rem; padding: 1rem 1.5rem;">
                                        <button class="btn btn-outline-secondary" type="submit">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <!-- Espacio vacío para mantener el layout -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" style="position: relative; z-index: 1;">
    <div class="col-md-3" style="position: relative;">
        <!-- Sidebar con filtros -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Categorías</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <a href="{% url 'products:product_list' %}" class="{% if not category %}active{% endif %}">
                            Todas las Categorías
                        </a>
                    </li>
                    {% for cat in categories %}
                        <li class="list-group-item">
                            <a href="{% url 'products:product_list_by_category' cat.slug %}"
                               class="{% if category and category.id == cat.id %}active{% endif %}">
                                {{ cat.name }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Filtros de ordenamiento -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Ordenar por</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button onclick="applySorting('name')"
                        class="btn btn-outline-secondary btn-sm {% if sort_by == 'name' %}active{% endif %}">
                        <i class="fas fa-sort-alpha-down me-2"></i>Nombre
                    </button>
                    <button onclick="applySorting('price_low')"
                        class="btn btn-outline-secondary btn-sm {% if sort_by == 'price_low' %}active{% endif %}">
                        <i class="fas fa-sort-numeric-down me-2"></i>Precio: Menor a Mayor
                    </button>
                    <button onclick="applySorting('price_high')"
                        class="btn btn-outline-secondary btn-sm {% if sort_by == 'price_high' %}active{% endif %}">
                        <i class="fas fa-sort-numeric-up me-2"></i>Precio: Mayor a Mayor
                    </button>
                    <button onclick="applySorting('rating')"
                        class="btn btn-outline-secondary btn-sm {% if sort_by == 'rating' %}active{% endif %}">
                        <i class="fas fa-star me-2"></i>Calificación
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtro por ubicación -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Buscar por Ubicación</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="distanceSlider" class="form-label">Distancia máxima: <span id="distanceValue">{{ max_distance|default:'10' }}</span> km</label>
                    <input type="range" class="form-range" id="distanceSlider" min="1" max="20" value="{{ max_distance|default:'10' }}" step="1">
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="locationButton" onclick="getUserLocation()">
                        <i class="fas fa-map-marker-alt"></i> Obtener ubicación
                    </button>
                    {% if user_lat %}
                    <button type="button" class="btn btn-outline-secondary" onclick="clearLocationFilter()">
                        <i class="fas fa-times"></i> Limpiar filtro
                    </button>
                    {% endif %}
                </div>
                <div id="locationStatus" class="mt-2 small text-muted">
                    {% if user_lat %}
                        <i class="fas fa-check-circle text-success"></i> Mostrando productos dentro de {{ max_distance|default:'10' }} km
                    {% else %}
                        Haz clic para filtrar productos por tu ubicación
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- Header con título, ordenamiento y acciones -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <h2 class="mb-0">
            {% if category %}
                Productos en {{ category.name }}
            {% elif search_query %}
                Resultados para "{{ search_query }}"
            {% else %}
                Todos los Productos
            {% endif %}
        </h2>

        <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
            {% if user.is_authenticated %}
                {% if is_pharmacy %}
                    <div class="btn-group w-100 w-sm-auto">
                        <a href="{% url 'products:product_create' %}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Agregar
                        </a>
                        <a href="{% url 'products:pharmacy_products' %}" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i> Mis Productos
                        </a>
                    </div>
                {% endif %}
            {% endif %}
        </div>
        </div>

        <!-- Lista de productos -->
        {% if page_obj %}
            <div class="row">
                {% for product in page_obj %}
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            {% if product.main_image %}
                                <img src="{{ product.main_image.url }}" class="card-img-top" alt="{{ product.name }}"
                                     style="height: 200px; object-fit: cover;">
                            {% else %}
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center"
                                     style="height: 200px;">
                                    <i class="fas fa-pills fa-3x text-muted"></i>
                                </div>
                            {% endif %}

                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">
                                    <a href="{% url 'products:product_detail' product.id %}" class="text-decoration-none">
                                        {{ product.name }}
                                    </a>
                                </h5>

                                <p class="card-text text-muted small">{{ product.pharmacy.pharmacy_name }}</p>

                                <div class="mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        {% if product.is_on_sale %}
                                            <div>
                                                <span class="text-decoration-line-through text-muted">{{ product.price }} USD</span>
                                                <span class="fw-bold text-danger">{{ product.discounted_price }} USD</span>
                                            </div>
                                        {% else %}
                                            <span class="fw-bold">{{ product.price }} USD</span>
                                        {% endif %}

                                        {% if product.pharmacy.rating %}
                                            <div>
                                                <i class="fas fa-star text-warning"></i>
                                                {{ product.pharmacy.rating|floatformat:1 }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <a href="{% url 'products:product_detail' product.id %}"
                                       class="btn btn-primary w-100">
                                        <i class="fas fa-eye"></i> Ver Detalles
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Paginación -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Paginación de productos">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if user_lat %}&lat={{ user_lat }}&lng={{ user_lng }}&distance={{ max_distance }}{% endif %}">
                                    Anterior
                                </a>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if user_lat %}&lat={{ user_lat }}&lng={{ user_lng }}&distance={{ max_distance }}{% endif %}">
                                        {{ num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}{% if user_lat %}&lat={{ user_lat }}&lng={{ user_lng }}&distance={{ max_distance }}{% endif %}">
                                    Siguiente
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-4x text-muted mb-3"></i>
                <h4>No se encontraron productos</h4>
                <p class="text-muted">Intenta con otros términos de búsqueda o explora nuestras categorías.</p>
                <a href="{% url 'products:product_list' %}" class="btn btn-primary">
                    <i class="fas fa-store"></i> Ver Todos los Productos
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
